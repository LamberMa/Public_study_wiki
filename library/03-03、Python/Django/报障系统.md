# æŠ¥éšœç³»ç»Ÿ

> èƒŒæ™¯ï¼šè§£å†³å†…å¤–è¿ç»´äººå‘˜å·¥ä½œæ•°å­—åŒ–
>
> éœ€æ±‚åˆ†æï¼š
>
> - æŠ¥éšœ
> - çŸ¥è¯†åº“

## æ•°æ®åº“è®¾è®¡

- ç”¨æˆ·ï¼Œæ–‡ç« ï¼Œç‚¹èµï¼Œè¯„è®º
- ç”¨æˆ·ä¹‹é—´äº’ç²‰ï¼Œæ–‡ç« æ ‡ç­¾
- ä¸ªäººåšå®¢ä¸»é¢˜å®šåˆ¶

```python
class UserInfo(models.Model):
    """ç”¨æˆ·è¡¨"""
    nid = models.BigAutoField(primary_key=True)
    username = models.CharField(verbose_name='ç”¨æˆ·å', max_length=32, unique=True)
    password = models.CharField(verbose_name='å¯†ç ', max_length=64)
    nickname = models.CharField(verbose_name='æ˜µç§°', max_length=32)
    email = models.EmailField(verbose_name='é‚®ç®±', unique=True)
    avatar = models.ImageField(verbose_name='å¤´åƒ')
    create_time = models.DateTimeField(verbose_name='åˆ›å»ºæ—¶é—´', auto_now_add=True)
    fans = models.ManyToManyField(
        verbose_name='ç²‰ä¸',
        to='UserInfo',
        # è‡ªå®šä¹‰çš„å…³è”
        through='UserFans',
        through_fields=('user', 'follower')
        related_name='f',
    )
    
    
class UserFans(models.Model):
    """äº’ç²‰å…³ç³»è¡¨"""
    user = models.ForeignKey(verbose_name='åšä¸»', to='UserInfo', to_field='nid', related_name='users')
    follower = models.ForeignKey(verbose_name='ç²‰ä¸', to='UserInfo', to_field='nid', related_name='followers')
    
    class Meta:
        unique_together = [
            ('user', 'follower'),
        ]
    
    
class Blog(models.Model):
    """åšå®¢ä¿¡æ¯"""
    nid = models.BigAutoField(primary_key=True)
    title = models.CharField(verbose_name='ä¸ªäººåšå®¢æ ‡é¢˜', max_length=64)
    site = models.CharField(verbose_name='ä¸ªäººåšå®¢å‰ç¼€', max_length=32, unique=True)
    theme = models.CharField(verbose_name='åšå®¢ä¸»é¢˜', max_length=32)
    # åšå®¢å’Œç”¨æˆ·æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œè¦ä¿è¯æ¯ä¸ªç”¨æˆ·çš„åšå®¢æ˜¯å”¯ä¸€çš„ã€‚
    # OneToOneå…¶å®å°±æ˜¯ä¸€ä¸ªForeignKey+Unique
    user = models.OneToOneField(to='UserInfo', to_field='nid')
    
    
class Category(models.Model):
    """åšä¸»ä¸ªäººæ–‡ç« åˆ†ç±»è¡¨"""
    nid = models.AutoField(primary_key=True)
    title = models.CharField(verbose_name='åˆ†ç±»æ ‡é¢˜', max_length=32)
    blog = models.ForeignKey(verbose_name='æ‰€å±åšå®¢', to='Blog', to_field='nid')
    

class Tag(models.Model):
    """æ ‡ç­¾è¡¨"""
    nid = models.AutoField(primary_key=True)
    title = models.CharField(verbose_name='æ ‡ç­¾åç§°', max_length=32)
    blog = models.ForeignKey(verbose_name='æ‰€å±åšå®¢', to='Blog', to_field='nid')
    
 
class Article(models.Model):
    nid = models.BigAutoField(primary_key=True)
    title = models.CharField(verbose_name='æ–‡ç« æ ‡é¢˜', max_length=128)
    summary = models.CharField(verbose_name='æ–‡ç« ç®€ä»‹', max_length=255)
    # é˜…è¯»ä¸ªæ•°ï¼Œè¯„è®ºä¸ªæ•°ï¼Œèµçš„ä¸ªæ•°ï¼Œè¸©çš„ä¸ªæ•°
    read_count = models.IntegerField(default=0)
    comment_count = modesl.IntegerField(default=0)
    up_count = modesl.IntegerField(default=0)
    down_count = modesl.IntegerField(default=0)
    create_time = models.DateTimeField(verboseA_name='åˆ›å»ºæ—¶é—´', auto_now_add=True)
    # æ‰€å±åšå®¢å’Œåˆ†ç±»
    blog = models.ForeignKey(verbose_name='æ‰€å±åšå®¢', to='Blog', to_field='nid')
    category = models.ForeignKey(verbose_name='æ–‡ç« ç±»å‹', to='Category', to_field='nid', null=True)
     
    type_choices = [
        (1, "Python"),
        (2, "Linux"),
        (3, "OpenStack"),
        (4, "GoLang"),
    ]
    article_type_id = models.IntegerField(choices=type_choices, default=None)
    tags = models.ManyToManyField(
        to="Tag",
        through='Article2Tag',
        through_fields=('article', 'tag'),
    )

    
class Article2Tag(models.Model):
    article = models.ForeignKey(verbose_name='æ–‡ç« ', to='Article', to_field='nid')
    tag = models.ForeignKey(verbose_name='æ ‡ç­¾', to='Tag', to_field='nid')
    
    class Meta:
        unique_together = [
            ('article', 'tag'),
        ]
    
    
class ArticleDetail(models.Model):
    """
    æ–‡ç« è¯¦ç»†è¡¨
    1ã€æ–‡ç« æ ‡é¢˜ï¼Œæ–‡ç« ç®€æ´ï¼Œæ–‡ç« å†…å®¹
    2ã€å¤–é”®å…³è”æ–‡ç« çš„å‘å¸ƒè€…åˆ°ç”¨æˆ·çš„åšå®¢ï¼Œå› æ­¤è¦æœ‰ä¸€ä¸ªåšå®¢id
    3ã€ä¸€ä¸ªæ–‡ç« åªèƒ½é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼Œä½†æ˜¯å…è®¸ä¸€ç¯‡æ–‡ç« é€‰æ‹©å¤šä¸ªæ ‡ç­¾
    4ã€æ–‡ç« å†…å®¹ä¸è¦å’Œæ–‡ç« è¡¨æ”¾åœ¨ä¸€èµ·ï¼Œæ‹†å¼€ï¼Œç„¶åå†åšä¸€ä¸ªä¸€å¯¹ä¸€çš„å…³è”
    """
    content = models.TextField(verbose_name='æ–‡ç« å†…å®¹',)
    article = models.OneToOneField(verbose_name='æ‰€å±æ–‡ç« ', to='Article', to_field='nid')
    
    
class Comment(models.Model):
    """
    è¯„è®ºè¡¨ï¼š
    1ã€éœ€è¦æœ‰ç”¨æˆ·idï¼Œè€Œä¸æ˜¯åšå®¢idï¼Œå› ä¸ºä¸æ³¨å†Œåšå®¢ä¹Ÿå¯ä»¥è¯„è®ºã€‚
    """
    nid = models.BigAutoField(primary_key=True)
    content = models.CharField(verbose_name='è¯„è®ºå†…å®¹', max_length=255)
    create_time = models.DateTimeField(verbose_name='åˆ›å»ºæ—¶é—´', auto_now_add=True)
    reply = models.ForeignKey(verbose_name='å›å¤è¯„è®º', to='self', related_name='back', )
    article = models.ForeignKey(verbose_name='è¯„è®ºæ–‡ç« ', to='Article', to_field='nid')
    user = models.ForeignKey(verbose_name='è¯„è®ºç”¨æˆ·', to='UserInfo', to_field='nid')
    
class UpDown(models.Model):
    """
    ç‚¹èµè¡¨ï¼š
    1ã€æ–‡ç« idï¼Œç”¨æˆ·idï¼Œèµè¿˜æ˜¯è¸©
    """
    article = models.ForeignKey(verbose_name='æ–‡ç« ', to='Article' to_field='nid')
    user = models.ForeignKey(verbose_name='èµæˆ–è¸©ç”¨æˆ·', to='UserInfo', to_field='nid')
    up = models.BooleanField(verbose_name='æ˜¯å¦èµ')
    class Meta:
        unique_together = [
            ('article', 'user'),
        ]
```

è¦ç‚¹ï¼š

- ImageFieldä¾èµ–Pillowï¼Œå› æ­¤éœ€è¦å®‰è£…pillowï¼š`pip install Pillow`
- â€‹





ä¸»é¡µç­›é€‰ï¼Œåˆ†é¡µï¼Œç™»å½•æˆåŠŸæ˜¾ç¤ºä¸ªäººä¿¡æ¯ï¼Œç™»å½•ï¼ŒéªŒè¯ç ï¼Œä½¿ç”¨Djangoçš„Formç»„ä»¶

åšæ³¨å†Œé¡µé¢ï¼Œå¤šåŠ ä¸€ä¸ªä¸Šä¼ ä¸ªäººå¤´åƒï¼Œ

 **BlogåŠŸèƒ½æ¦‚è¦**

`models.Article.objects.filter(blog__site='wupeiqi')`

ä¸»é¢˜å®šåˆ¶ï¼š

```html
<link rel=xxx href='/static/xxx/theme/{{ blog.theme }}.css'>
```

å…¶å®å°±æ˜¯å®šåˆ¶å¤šå¥—cssæ–‡ä»¶ï¼Œæ ¹æ®ä¸åŒçš„ä¸»é¢˜åç§°è°ƒç”¨ä¸åŒçš„css

ä¸Šä¼ å®Œå¤´åƒä»¥åè¦æœ‰é¢„è§ˆï¼Œæ˜¯ä¸Šä¼ å®Œäº†ä»¥åå°±è¦æœ‰é¢„è§ˆï¼Œè€Œä¸æ˜¯ç‚¹äº†æäº¤ä»¥åæœ‰é¢„è§ˆã€‚

```shell
(blog1) âœ  django-blog-master > python manage.py makemigrations -h   
usage: manage.py makemigrations [-h] [--version] [-v {0,1,2,3}]
                                [--settings SETTINGS]
                                [--pythonpath PYTHONPATH] [--traceback]
                                [--no-color] [--dry-run] [--merge] [--empty]
                                [--noinput] [-n NAME] [-e] [--check]
                                [app_label [app_label ...]]

Creates new migration(s) for apps.

positional arguments:
  app_label             Specify the app label(s) to create migrations for.

optional arguments:
  -h, --help            show this help message and exit
  --version             show program's version number and exit
  -v {0,1,2,3}, --verbosity {0,1,2,3}
                        Verbosity level; 0=minimal output, 1=normal output,
                        2=verbose output, 3=very verbose output
  --settings SETTINGS   The Python path to a settings module, e.g.
                        "myproject.settings.main". If this isn't provided, the
                        DJANGO_SETTINGS_MODULE environment variable will be
                        used.
  --pythonpath PYTHONPATH
                        A directory to add to the Python path, e.g.
                        "/home/djangoprojects/myproject".
  --traceback           Raise on CommandError exceptions
  --no-color            Don't colorize the command output.
  --dry-run             Just show what migrations would be made; don't
                        actually write them.
  --merge               Enable fixing of migration conflicts.
  --empty               Create an empty migration.
  --noinput, --no-input
                        Tells Django to NOT prompt the user for input of any
                        kind.
  -n NAME, --name NAME  Use this name for migration file(s).
  -e, --exit            Exit with error code 1 if no changes needing
                        migrations are found. Deprecated, use the --check
                        option instead.
  --check               Exit with a non-zero status if model changes are
                        missing migrations.
```

èµæˆ–è€…è¸©

### ä½¿ç”¨Djangoå®ç°å¤šçº§è¯„è®º

#### å‰æˆ

```python
In [5]: v1
Out[5]: [1, 2, 3]

In [6]: id(v1)
Out[6]: 4497008776

In [7]: v1.append(123)

In [8]: v1
Out[8]: [1, 2, 3, 123]

In [9]: id(v1)
Out[9]: 4497008776
    
In [10]: v1 = {'k1':'v1'}

In [11]: id(v1)
Out[11]: 4497937608

In [12]: v1['k2'] = 'v2'

In [13]: v1
Out[13]: {'k1': 'v1', 'k2': 'v2'}

In [14]: id(v1)
Out[14]: 4497937608
    
In [28]: data
Out[28]: [[11, 22, 33], [44, 55, 66]]

In [29]: data[0].append(data[1])

In [30]: data
Out[30]: [[11, 22, 33, [44, 55, 66]], [44, 55, 66]]

In [31]: id(data[1]) == id(data[0][3])
Out[31]: True

In [32]: data[1].append(77)

In [33]: data
Out[33]: [[11, 22, 33, [44, 55, 66, 77]], [44, 55, 66, 77]]
```





#### æ¨¡æ‹Ÿè®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„

å‡è®¾ç°åœ¨ä»æ•°æ®åº“å–å‡ºæ¥æŸä¸€ç¯‡æ–‡ç« çš„ç»“æœæ˜¯ä¸€ä¸ªè¯„è®ºåˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæ¯ä¸€ä¸ªå­—å…¸æ˜¯ä¸€æ¡è¯„è®ºçš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å«ä¿¡æ¯çš„idå’Œå†…å®¹ä»¥åŠä»å±çš„çˆ¶çº§è¯„è®ºçš„idã€‚

```python
msg_list = [
            {'id': 1, 'content': 'å†™çš„å¤ªå¥½äº†', 'parent_id': None},
            {'id': 2, 'content': 'ä½ è¯´å¾—å¯¹', 'parent_id': None},
            {'id': 3, 'content': 'é¡¶æ¥¼ä¸Š', 'parent_id': None},
            {'id': 4, 'content': 'ä½ çœ¼çå—', 'parent_id': 1},
            {'id': 5, 'content': 'æˆ‘çœ‹æ˜¯', 'parent_id': 4},
            {'id': 6, 'content': 'é¸¡æ¯›', 'parent_id': 2},
            {'id': 7, 'content': 'ä½ æ˜¯æ²¡å‘€', 'parent_id': 5},
            {'id': 8, 'content': 'æƒºæƒºæƒœæƒºæƒºæƒ³å¯»', 'parent_id': 3},
]
```

å…¶å®æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½å°±æ˜¯æŠŠå¯¹åº”çš„è¯„è®ºçš„å­è¯„è®ºé™„åŠ åˆ°çˆ¶çº§è¯„è®ºä¸­å»ï¼Œå› æ­¤è¦æˆ‘ä»¬è‡ªå·±å»å®šä¹‰ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚

```
# å¸¦childçš„msg_listï¼Œæ³¨æ„åˆ—è¡¨ç”Ÿæˆå¼ä¸­ä¸èƒ½å†™è¡¨è¾¾å¼ï¼Œæ¯”å¦‚row['child'] = []æ˜¯ä¸è¡Œçš„
# v = [row.setdefault('child', []) for row in msg_list]
# print(msg_list)
msg_list_dict = {}

for item in msg_list:
    item['child'] = []
    msg_list_dict[item['id']] = item


result = []
for item in msg_list:
    if item['parent_id']:
        msg_list_dict[pid]['child'].append(item)
    else:
        result.append(item)
# è¯„è®ºå±‚æ•°ä¸ºä¸¤å±‚   
###################################
"""
<div class='comment'>
	<div class='content'>asdasd</div>
	<div class='content'>asdasd</div>
	<div class='content'>asdasd</div>
	<div class='content'>asdasd</div>
</div>
"""
comment_str = """"""
comment_str += "<div class='comment'>"
for row in result:
    tpl = "<div class='content'>%s</div>" % (row['content'])
    if row['child']:
        comment_str += "<div class='comment'>"
        for jow in row['child']:
            tpl = "<div class='content'>%s</div>" % (jow['content'])
            comment_str += tpl
        comment_str += "</div>"
    comment_str += tpl
comment_str += "</div>"
# æŠŠè¿™ä¸ªå†…å®¹ä¼ é€’åˆ°å‰å°


# 
```





ä¸ºä»€ä¹ˆå­—å…¸å–å€¼å¿«ï¼Ÿ

msg_listæ˜¯æ•°æ®æºï¼Œmsg_list_dictç”¨æˆ·æŸ¥æ‰¾ã€‚



![](http://omk1n04i8.bkt.clouddn.com/18-3-7/48996755.jpg)

è®°å¾—å‰ç«¯çš„ä»£ç è¦åŠ ä¸Š`|safe`æ‰è¡Œã€‚å› æ­¤åœ¨ç”¨æˆ·å‘å¸ƒæ–‡ç« çš„æ—¶å€™è¦åšç‰¹æ®Šçš„è¿‡æ»¤ã€‚é¿å…ç”¨æˆ·å‘å¸ƒæœ‰å®³çš„å†…å®¹ã€‚

æ–‡ç« ç‚¹èµï¼š

```html
<a onclick="up(this, {{ obj.nid }}, 0)">
  <span>ğŸ‘</span>
  <i>{{ obj.up_count }}</i>
</a>

<a>
  <span>è¸©</span>
  <i>{{ obj.down_count }}</i>
</a>


<script>
  function up(ths, nid){
    $.ajax({
      url:'/up.html',
      data:{'val':1,'nid':nid,'csrfmiddlewaretoken':{{ csrf_token }}},
      type:"POST",
      dataType:'JSON',
      success:function(arg){
      	if(arg.status){
        	// æ˜¾ç¤ºèµçš„ä¸ªæ•°+1
        }else{
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        }
      }
    })
  }

function down(ths, nid){
    $.ajax({
      url:'/up.html',
      data:{'val':0,'nid':nid,'csrfmiddlewaretoken':{{ csrf_token }}},
      type:"POST",
      dataType:'JSON',
      success:function(arg){
      	if(arg.status){
        	// æ˜¾ç¤ºè¸©çš„ä¸ªæ•°+1
        }else{
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        }
      }
    })
  }
  
function updown(ths, nid, val){
    $.ajax({
      url:'/up.html',
      data:{'val':val,'nid':nid,'csrfmiddlewaretoken':{{ csrf_token }}},
      type:"POST",
      dataType:'JSON',
      success:function(arg){
      	if(arg.status == xxxx){
        	// ç»™å‰æ®µè¿”å›ç‰¹æ®Šçš„çŠ¶æ€ç 
        }else{
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        }
      }
    })
  }
</script>


æ˜¯å“ªä¸ªç”¨æˆ·ï¼Œæ–‡ç« è¸©æˆ–è€…èµ
æ˜¯è°ï¼Œå½“å‰ç™»å½•ç”¨æˆ·
1æ˜¯èµï¼Œ0æ˜¯è¸©ã€‚


```

python

```python
def up(request):
    userid = request.session.get('user_id')
    article_id = request.POST.get('nid')
    val = request.POST.get('val')

    # ä»ç„¶ä¼šå­˜åœ¨æŠ¥é”™ï¼Œç”¨äºæ•è·æŠ¥é”™
    try:
        # è¿™ä¸ªæ˜¯é’ˆå¯¹æŸä¸€ä¸ªç”¨æˆ·çš„ç‚¹èµè®°å½•ï¼Œå¦‚æœæœ‰ç‚¹èµè®°å½•çš„è¯å°±å¯ä»¥å»åˆ°ä¸€ä¸ªå¯¹è±¡
        obj = models.UpDown.objects.filter(user_id=userid, article_id=article_id).first()
        if obj:
            pass
        else:
            # å–ä¸åˆ°å¯¹è±¡å°±å¯ä»¥è¿›è¡Œæ·»åŠ 
            if val == "0":
                # å¼•å…¥äº‹ç‰©ï¼Œæ‰€è°“äº‹ç‰©å°±æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œå°†ä¸‹é¢ä¸¤ä¸ªæ“ä½œä½œä¸ºåŸå­æ€§çš„æ“ä½œï¼Œè¦æˆåŠŸå°±ä¸¤ä¸ªä¸€èµ·æˆåŠŸï¼Œè¦ä¸æˆåŠŸå°±éƒ½ä¸æˆåŠŸ
                # ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ï¼Œåœ¨ç‚¹èµè¡¨é‡Œæ·»åŠ ç‚¹èµè®°å½•ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨æ–‡ç« è¡¨é‡Œæ·»åŠ ç‚¹èµæŠ€æœ¯ï¼ŒäºŒè€…ç›¸è¾…ç›¸æˆï¼Œè¦æˆåŠŸå°±éƒ½æˆåŠŸã€‚
                # äº‹ç‰©çš„ä½œç”¨å°±æ˜¯å¯¹ä¸‹é¢ä¸¤ä¸ªæ“ä½œåšé™åˆ¶ï¼Œå¦‚æœæœ‰å…¶ä¸­ä¸€ä¸ªå¤±è´¥ï¼Œé‚£ä¹ˆæ•´ä¸ªæ“ä½œä¼šå›æ»š
                with transaction.atomic():
                    # ä½†æ˜¯ä»ç„¶è¦æ•è·å¼‚å¸¸
                    models.UpDown.objects.create(user_id=userid, article_id=article_id, up=True)
                    models.Article.objects.filter(nid=article_id).update(up_count=F('up_count') + 1)
            else:
                with transaction.atomic():
                    models.UpDown.objects.create(user_id=userid, article_id=article_id, up=False)
                    models.Article.objects.filter(nid=article_id).update(up_count=F('up_count') - 1)
    except Exception as e:
        pass
```

ç»„åˆç­›é€‰





### kindEditor

> http://www.cnblogs.com/wupeiqi/articles/6307554.html

ä¸‹è½½ä¸‹æ¥æ˜¯ä¸€ä¸ªzipçš„å‹ç¼©åŒ…ï¼Œè§£å‹åé‡Œé¢å¯ä»¥åˆ é™¤æ‰ä¸€äº›å†…å®¹ï¼Œæ¯”å¦‚aspã€asp.netã€jspã€phpè¿™äº›éƒ½æ˜¯é’ˆå¯¹è¿™äº›è¯­è¨€å†™çš„ä¸€äº›å®ä¾‹ï¼Œåœ¨è¿™é‡Œä½¿ç”¨ä¸åˆ°ï¼Œå¯ä»¥ç›´æ¥å¹²æ‰ã€‚



ç¼–è¾‘å™¨åˆå§‹åŒ–å‚æ•°è¯´æ˜ï¼šhttp://kindeditor.net/doc3.php?cmd=config

```
itemï¼šè®¾ç½®å·¥å…·é¡¹ï¼Œæ¥æ”¶ä¸€ä¸ªæ•°ç»„
noDisableItemsï¼šé…åˆdesignModeè¦ä¸ºfalseï¼Œå¯ä»¥æŒ‡å®šæŸäº›æ˜¾ç¤ºçš„å·¥å…·ä¸è®©ä½ ä½¿ç”¨
htmlTagsï¼šä¸€ä¸ªå­—å…¸ï¼Œé™åˆ¶è¿™é‡Œåªå…è®¸å‡ºç°å“ªäº›æ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾ä»…æœ‰å“ªäº›å±æ€§ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½å¾ˆé¸¡è‚‹ã€‚è¿™ä¸ªåªæ˜¯åœ¨é€‰çš„æ—¶å€™åšé™åˆ¶ï¼Œä½†æ˜¯å½“çº¯htmlä»£ç çš„æ—¶å€™ï¼Œä»ç„¶æ˜¯å¯ä»¥æäº¤åˆ°åç«¯çš„ã€‚
```

ä¸Šä¼ å›¾ç‰‡ï¼š

é’ˆå¯¹æäº¤å†…å®¹çš„è¿‡æ»¤ã€‚æ¯”å¦‚æäº¤çš„å†…å®¹æœ‰scriptæ ‡ç­¾

ä½¿ç”¨BeautifulSoapè¿‡æ»¤è¿è§„æ ‡ç­¾ï¼š

```python
pip3 install BeautifulSoup4
```

BeautifulSoap4ä¼šæŠŠä¸€ä¸ªhtmlæ–‡æœ¬è½¬æ¢æˆä¸€ä¸ªå¯¹è±¡

www.cnblogs.com/wupeiqi/article/6283017.html



## ä½¿ç”¨JSå®ç°ä¸€ä¸ªå¤šçº§è¯„è®º



## ç”¨æˆ·çš„æƒé™ç®¡ç†

å…³äºç”¨æˆ·æƒé™çš„ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒçš„è§’è‰²å»è®¾è®¡ã€‚æ¯”å¦‚å¸¸è§çš„discuzè®ºå›ï¼Œæˆ–è€…å…¶ä»–çš„è®ºå›ï¼Œå†…éƒ¨åŒ…æ‹¬æ¸¸å®¢ï¼Œæ™®é€šç”¨æˆ·ï¼Œç®¡ç†å‘˜ï¼Œå®¡æ ¸å‘˜ï¼Œè¶…çº§ç®¡ç†å‘˜ç­‰ç­‰ã€‚ç»è¿‡å®šåˆ¶åŒ–çš„è®ºå›è¿˜ä¼šå‡ºç°è¯¸å¦‚VIPç­‰è§’è‰²ï¼Œå…¶å®è¯´ç™½äº†å°±æ˜¯ä¸åŒçš„è§’è‰²å¯¹åº”åˆ°äº†ä¸åŒçš„æƒé™ã€‚ä¸ºäº†ä¿è¯æƒé™çš„ç®¡ç†å¯ä»¥è¢«å»¶ç”¨ï¼Œå› æ­¤å¯ä»¥ç‹¬ç«‹å»å¼€è¾Ÿä¸€ä¸ªappå»ç®¡ç†è¿™ä¸€éƒ¨åˆ†ã€‚

```python
python manage.py startapp app02
```

ç”¨æˆ·ä¸è§’è‰²è¿›è¡Œå¯¹åº”ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥å¯¹åº”å¤šä¸ªè§’è‰²ï¼Œä¸€ä¸ªè§’è‰²ä¹Ÿå¯ä»¥è¢«å¤šä¸ªç”¨æˆ·æ‰€å¯¹åº”ï¼Œé‚£ä¹ˆè¿™å…¶å®æ˜¯ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªä¸­é—´è¡¨å°†è¿™ä¸¤ä¸ªå…³è”èµ·æ¥ã€‚

![ç”¨æˆ·è§’è‰²å…³ç³»ç¤ºä¾‹](http://omk1n04i8.bkt.clouddn.com/18-3-13/56728684.jpg)



ç”¨æˆ·è§’è‰²å¯¹åº”èµ·æ¥äº†ä»¥åï¼Œä¸åŒçš„è§’è‰²å¯¹åº”çš„ä¹Ÿå°±æ˜¯ä¸åŒçš„æƒé™ã€‚











æ ¹æ®urlåˆ’åˆ†æƒé™ï¼Œæ‰€ä»¥åº”è¯¥è¦æä¸Šä¸€ä¸ªè¡¨ï¼Œä¿å­˜æ‰€æœ‰çš„urlåœ°å€ï¼Œç”¨æˆ·å’Œæƒé™urlæ˜¯ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»ã€‚ç»™ç”¨æˆ·çš„åŠŸèƒ½å°±æä¸€ä¸ªurlï¼Œç„¶åé€šè¿‡ç»™urlä¼ çš„å‚æ•°ä¸ä¸€è‡´åŒºåˆ†ä¸åŒçš„åŠŸèƒ½

```html
/users.html
/users.html?md=get
/users.html?md=post
/users.html?md=edit
/users.html?md=del
```

![](http://omk1n04i8.bkt.clouddn.com/18-3-12/33596170.jpg)

ä¸€èˆ¬ææƒé™ä¸ä¼šå®šä½åˆ°äººï¼Œè€Œæ˜¯å®šä½ä¸€ä¸ªè§’è‰²ï¼Œé€šè¿‡è§’è‰²å»æ§åˆ¶ä¸€ä¸ªäººåº”è¯¥æœ‰ä»€ä¹ˆæƒé™ã€‚

easyUi_Tree

![](http://omk1n04i8.bkt.clouddn.com/18-3-12/44631724.jpg)



### ç”¨æˆ·æƒé™èœå•å¤„ç†

å¤„ç†ç”¨æˆ·çš„èœå•æƒé™ï¼Œè¦è·å–åˆ°ç”¨æˆ·çš„ç”¨æˆ·åæˆ–è€…ç”¨æˆ·çš„idï¼Œè¿™ä¸ªæ˜¯è¦ä¼ é€’è¿‡æ¥çš„æ•°æ®ã€‚

```python
# é¦–å…ˆè·å–åˆ°æ‰€æœ‰çš„èœå•ï¼Œåªå–idï¼Œcaptionï¼Œparent_idå­—æ®µ
all_menu_list = models.Menu.objects.all().values('id', 'caption', 'parent_id')

# è¿™ä¸ªæ•°æ®è·å–åˆ°çš„å†…å®¹åº”è¯¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ˆQuerySetï¼‰å¥—å­—å…¸ã€‚æ ¼å¼å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤ºï¼š
[
    {'id': 1, 'caption': '1.0', 'parent_id': None}
	{'id': 2, 'caption': '2.0', 'parent_id': None}
	{'id': 3, 'caption': '3.0', 'parent_id': None}
	{'id': 4, 'caption': '1.1', 'parent_id': 1}
	{'id': 5, 'caption': '2.1', 'parent_id': 2}
	{'id': 6, 'caption': '3.1', 'parent_id': 3}
	{'id': 7, 'caption': '1.1.1', 'parent_id': 4}
	{'id': 8, 'caption': '1.1.1.1', 'parent_id': 7}
	{'id': 9, 'caption': '1.1.2', 'parent_id': 4}
	{'id': 10, 'caption': '2.1.1', 'parent_id': 5}
	{'id': 11, 'caption': '2.1.2', 'parent_id': 5}
	{'id': 12, 'caption': '3.1.1', 'parent_id': 6}
	{'id': 13, 'caption': '3.1.2', 'parent_id': 6}
]
```

é¦–å…ˆè·å–ç”¨æˆ·å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åº”è¯¥æ˜¯ä»è®¿é—®è¿æ¥ä¼ é€’è¿‡æ¥çš„ï¼Œç°åœ¨å…ˆå¯ä»¥ä¸´æ—¶å†™æ­»ä»£æ›¿ï¼Œæœ€åå†è°ƒæ•´ï¼š

```python
# æ ¹æ®ä¼ é€’è¿‡æ¥çš„usernameæ‹¿åˆ°ç”¨æˆ·å¯¹è±¡
user = models.User.objects.filter(username='mxy').first()
# æ ¹æ®ç”¨æˆ·å¯¹è±¡å¯ä»¥æ‹¿åˆ°ç”¨æˆ·çš„è§’è‰²å¯¹è±¡åˆ—è¡¨ï¼Œç”¨æˆ·ä¸ä¸€å®šåªæœ‰ä¸€ä¸ªè§’è‰²
role_list = models.Role.objects.filter(users__user=user)
# é€šè¿‡è§’è‰²åˆ—è¡¨ï¼Œå°±å¯ä»¥çŸ¥é“è¿™ä¸ªç”¨æˆ·å®é™…å¯ä»¥æ“ä½œçš„æƒé™åˆ°åº•æœ‰å“ªäº›äº†
# è¿™é‡Œå–åˆ°çš„æœ‰æƒé™è¡¨ä¸­æ•°æ®é¡¹çš„idï¼Œurlï¼Œå·²ç»å…³è”èœå•çš„idï¼Œæƒé™åç§°ã€‚
# å› ä¸ºä¸åŒçš„è§’è‰²å¯èƒ½æœ‰å¤åˆçš„æƒé™ï¼Œå› æ­¤ä½¿ç”¨distinctå»é‡ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨annotateå»é‡
# distinctå°±æ˜¯æ²¡æœ‰å¤šåŠ é‚£ä¸€åˆ—ï¼Œä½†æ˜¯æ€§èƒ½è¦ç•¥ä½äºannotate
permission_list = models.Permission2Action2Role.objects.filter(role__in=role_list).values(
    'permission__id',                                                                                    	 'permission__url',                                                                                           	  'permission__menu_id',                                                                                                 	 'permission__caption').distinct()           

# å–åˆ°çš„permission_listä¹Ÿæ˜¯ä¸€ä¸ªåˆ—è¡¨å¥—å­—å…¸ï¼Œå¦‚ä¸‹çš„ä¸€ä¸ªå½¢å¼ã€‚

[
    {
        'permission__id': 4, 
        'permission__url': '/create-group-(\\d+).html', 
        'permission__menu_id': 10, 
        'permission__caption': 'ç»„ç»‡åˆ›å»º'
    }
	{
        'permission__id': 1, 
        'permission__url': '/edit.html', 
        'permission__menu_id': 7, 
        'permission__caption': 'æ–‡ç« ç¼–è¾‘'
    }
	{
        'permission__id': 2, 
        'permission__url': '/edit-cat.html', 
        'permission__menu_id': 8, 
        'permission__caption': 'åˆ†ç±»ç¼–è¾‘'
    }
	{
        'permission__id': 3, 
        'permission__url': '/create-cat.html', 
        'permission__menu_id': 9, 
        'permission__caption': 'åˆ†ç±»åˆ›å»º'
    }
]
```

ç°åœ¨æƒé™éƒ½æ‹¿åˆ°äº†å°±åº”è¯¥æŠŠæƒé™æŒ‚åˆ°å¯¹åº”çš„èœå•ä¸Šäº†ã€‚é¦–å…ˆæŠŠèœå•å¤„ç†æˆçˆ¶å­å½¢å¼çš„å…³ç³»ã€‚

```python
# å®šä¹‰ä¸€ä¸ªmenu_dictç©ºå­—å…¸
all_menu_dict = {}

# ä¸ºæ¯ä¸€ä¸ªèœå•é¡¹æ·»åŠ ä¸€ä¸ªchildå­é€‰é¡¹ï¼Œå‡å¦‚è¯´èœå•æœ‰å­èœå•çš„è¯å¯ä»¥æŒ‚åœ¨é‡Œé¢
# å®šä¸€ä¸ªstatusçš„keyï¼Œè¡¨ç¤ºæ˜¯å¦æ˜¾ç¤ºèœå•ï¼Œé»˜è®¤ä¸ºFalse
# å®šä¹‰openedçš„keyï¼Œè¡¨ç¤ºé»˜è®¤æ˜¯å¦æ‰“å¼€ï¼Œé»˜è®¤ä¸ºFalse
# æœ€åé€šè¿‡å¾ªç¯éå†æŠŠæ¯ä¸€ä¸ªèœå•åŠ åˆ°all_menu_dictè¿™ä¸ªå­—å…¸é‡Œå»ã€‚keyä¸ºidï¼Œvalueä¸ºå­—å…¸
for row in all_menu_list:
    row['child'] = []  
    row['status'] = False  
    row['opened'] = False  
    all_menu_dict[row['id']] = row

# å…³è”æƒé™å’Œå¯¹åº”çš„èœå•
for per in permission_list:
	# ä¸åœ¨èœå•ä¸Šæ˜¾ç¤ºçš„æƒé™ï¼Œæ¯”å¦‚æ˜¯å¦å…è®¸ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼Œä¸Šä¼ æ–‡ä»¶ç­‰ã€‚è¿™ä¸ªæ˜¯ä¸éœ€è¦æŒ‚é åˆ°èœå•çš„ã€‚
    if not per['permission__menu_id']:
        continue

    item = {
        'id': per['permission__id'],
        'caption': per['permission__caption'],
        'parent_id': per['permission__menu_id'],
        'url': per['permission__url'],
        # æ˜¯å¦æ˜¾ç¤ºèœå•ï¼Œå¦‚æœè¿™ä¸ªç”¨æˆ·å¯¹åº”çš„æƒé™æœ‰è¿™ä¸ªèœå•çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªèœå•åº”è¯¥æ˜¾ç¤ºå‡ºæ¥
        # åªæœ‰å½“å‰URLå’Œç”¨æˆ·è¯·æ±‚çš„URLåŒ¹é…ä¸Šäº†æ‰ä¼šå˜æˆTrueï¼Œæ‰€ä»¥é»˜è®¤False
        # ç„¶åæ ¹æ®URLçš„æ­£åˆ™å»åˆ¤æ–­æ˜¯å¦ä¸ºTrueã€‚
        'status': True,
        'opened': False
    }
    # å½“ç”¨æˆ·è®¿é—®è¿‡æ¥çš„è¯·æ±‚æ»¡è¶³è¿™ä¸ªæ­£åˆ™urlçš„æ—¶å€™ï¼Œæ‰æ˜¯å…è®¸æ‰“å¼€çš„ã€‚
    if re.match(per['permission__url'],request.path_info):
        item['opened'] = True
    # è·å–æƒé™æ‰€å±çš„çˆ¶çº§èœå•çš„idã€‚
    pid = item['parent_id']
    # æ“ä½œå®Œäº†æ‰€æœ‰çš„èœå•éƒ½æŒ‚é å®Œæ¯•äº†
    all_menu_dict[pid]['child'].append(item)
    
    # å°†å½“å‰æƒé™å‰è¾ˆstatus=True
    temp = pid  # 1.çˆ¶äº²ID
    # å½“çˆ¶çº§id=Noneçš„æ—¶å€™é‚£ä¹ˆå°±è¯æ˜æ‰¾åˆ°å¤´äº†ã€‚
    # è€Œä¸”å¦‚æœå½“å‰çˆ¶çº§èœå•çš„statusä¸ºtrueçš„æ—¶å€™å°±ä¸éœ€è¦ç»§ç»­å¾ªç¯äº†ï¼Œè¯æ˜å·²ç»æ”¹è¿‡äº†
    while not all_menu_dict[temp]['status']:
        all_menu_dict[temp]['status'] = True
        temp = all_menu_dict[temp]['parent_id']
        if not temp:
            break

    # å°†å½“å‰æƒé™å‰è¾ˆopened=True
    if item['opened']:
        temp1 = pid  # 1.çˆ¶äº²ID
        while not all_menu_dict[temp1]['opened']:
            all_menu_dict[temp1]['opened'] = True
            temp1 = all_menu_dict[temp1]['parent_id']
            if not temp1:
                break

# åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæƒé™å°±ç®—æ˜¯æŒ‚é å®Œæ¯•äº†ï¼Œå¤„ç†è¿‡åçš„all_menu_dictæ˜¯ä¸€ä¸ªå­—å…¸å¥—å­—å…¸çš„å½¢å¼
# å†…éƒ¨çš„menuçš„idä¸ºkey
```

æ¥ä¸‹æ¥å°±è¦å¼€å§‹å¤„ç†èœå•äºèœå•ä¹‹é—´çš„å…³ç³»äº†ï¼Œå› ä¸ºèœå•ä¹‹é—´ä¹Ÿæ˜¯æœ‰çˆ¶å­å…³ç³»çš„ã€‚

```python
result = []
for row in all_menu_list:
    pid = row['parent_id']
    if pid:
        all_menu_dict[pid]['child'].append(row)
    else:
        result.append(row)
```







### RBAC

> Role Basic Access ControlåŸºäºè§’è‰²çš„ç”¨æˆ·è®¿é—®çš„æ§åˆ¶ã€‚

æ”¹å˜Django Adminçš„å¯†ç ï¼š

```python
è¿è¡Œï¼špython manage.py shell


>>> from django.contrib.auth.models import User

>>> u = User.objects.get(username__exact='john')
>>> u.set_password('new password')
>>> u.save()
```



