# Linux centos6 内核参数优化

## sysctl

> 使用sysctl命令来进行内核参数的调整

Sysctl命令用来配置与显示在/proc/sys目录中的内核参数．如果想使参数长期保存，可以通过编辑/etc/sysctl.conf文件来实现。

参数：

- -w：临时改变某一个参数的值，比如：`sysctl -w net.ipv4.ip_forward=1`
- -a ：显示所有的的系统参数
- -p：从指定的文件加载系统参数,默认从/etc/sysctl.conf 文件中加载。

### 内核参数的调整方式

**方法一：**

修改/proc下内核参数文件内容，不能使用编辑器来修改内核参数文件，理由是由于内核随时可能更改这些文件中的任意一个，另外，这些内核参数文件都是虚拟文件，实际中不存在，因此不能使用编辑器进行编辑，而是使用echo命令，然后从命令行将输出重定向至 /proc 下所选定的文件中。如：将 timeout_timewait 参数设置为30秒：

\# echo 30 > /proc/sys/net/ipv4/tcp_fin_timeout

参数修改后立即生效，但是重启系统后，该参数又恢复成默认值。因此，想永久更改内核参数，需要修改/etc/sysctl.conf文件

 **方法二：**

修改/etc/sysctl.conf文件。检查sysctl.conf文件，如果已经包含需要修改的参数，则修改该参数的值，如果没有需要修改的参数，在sysctl.conf文件中添加参数。如：

```shell
net.ipv4.tcp_fin_timeout=30
```

保存退出后，可以重启机器使参数生效，如果想使参数马上生效，也可以执行如下命令：

 ```
sysctl  -p
 ```

## 优化参数详细说明：

```shell
net.ipv4.ip_forward = 0
# 解析：开启ip转发的支持，这个是实现nat的第一步

net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.accept_source_route = 0
kernel.sysrq = 0
kernel.core_uses_pid = 1
net.ipv4.tcp_syncookies = 1
# 表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；

kernel.msgmnb = 4203520
kernel.msgmax = 65536
kernel.msgmni = 64
kernel.shmmax = 68719476736
kernel.shmall = 4294967296

net.ipv4.tcp_fin_timeout = 10
# 表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间。

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 1
net.ipv4.tcp_keepalive_intvl = 1
# 意思是如果某个TCP连接在idle 600s后,内核才发起probe.如果probe 1次(每次1秒)不成功,内核才彻底放弃,认为该连接已失效.对服务器而言,可以调整的低一些. 可调整到: 
# /proc/sys/net/ipv4/tcp_keepalive_time 1800 
# /proc/sys/net/ipv4/tcp_keepalive_intvl 30 
# /proc/sys/net/ipv4/tcp_keepalive_probes 3

net.ipv4.tcp_max_tw_buckets = 20000
# 表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。默认为 180000，改为 5000。对于Apache、Nginx等服务器，上几行的参数可以很好地减少TIME_WAIT套接字数量，但是对于Squid，效果却不大。此项参数可以控制TIME_WAIT套接字的最大数量，避免Squid服务器被大量的TIME_WAIT套接字拖死。

net.ipv4.tcp_max_syn_backlog = 2048
# 进入SYN包的最大请求队列.默认1024.对重负载服务器,可调整到2048

net.core.netdev_max_backlog = 65536
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_sack = 1
net.core.somaxconn = 65500
# listen()的默认参数,挂起请求的最大数量.默认是128.对繁忙的服务器,增加该值有助于网络性能.可调整到256.

net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
# 最大socket读buffer，可参考优化值为873200

net.core.wmem_max = 16777216
# 最大socket写buffer，可参考优化值为873200

net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_syn_retries = 1
# 解析：

net.ipv4.tcp_tw_recycle = 1
# 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。

net.ipv4.tcp_tw_reuse = 1
# 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；

net.ipv4.tcp_mem = 786432 2097152 3145728
# 对应有三个值意思分为为：
# net.ipv4.tcp_mem[0]:低于此值,TCP没有内存压力. 
# net.ipv4.tcp_mem[1]:在此值下,进入内存压力阶段. 
# net.ipv4.tcp_mem[2]:高于此值,TCP拒绝分配socket. 
# 上述内存单位是页,而不是字节.可参考的优化值是:786432 1048576 1572864

net.ipv4.tcp_rmem = 4096 4096 16777216
# tcp读buffer

net.ipv4.tcp_wmem = 4096 4096 16777216
# tcp写buffer

net.ipv4.tcp_max_orphans = 3276800
net.ipv4.ip_local_port_range = 20000  65535
# 指定一个本地端口的范围

net.nf_conntrack_max = 104857600
net.netfilter.nf_conntrack_max = 104857600
net.netfilter.nf_conntrack_tcp_timeout_established = 300
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
net.unix.max_dgram_qlen = 100
```

## 整体参数参考内容如下：

```shell
net.ipv4.ip_forward = 0
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.accept_source_route = 0
kernel.sysrq = 0
kernel.core_uses_pid = 1
net.ipv4.tcp_syncookies = 1
kernel.msgmnb = 4203520
kernel.msgmax = 65536
kernel.msgmni = 64
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 1
net.ipv4.tcp_keepalive_intvl = 1
net.ipv4.tcp_max_tw_buckets = 20000
net.ipv4.tcp_max_syn_backlog = 2048
net.core.netdev_max_backlog = 65536
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_sack = 1
net.core.somaxconn = 65500
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_mem = 786432 2097152 3145728
net.ipv4.tcp_rmem = 4096 4096 16777216
net.ipv4.tcp_wmem = 4096 4096 16777216
net.ipv4.tcp_max_orphans = 3276800
net.ipv4.ip_local_port_range = 20000  65535

net.nf_conntrack_max = 104857600
net.netfilter.nf_conntrack_max = 104857600
net.netfilter.nf_conntrack_tcp_timeout_established = 300
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
net.unix.max_dgram_qlen = 100
```

